<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">

<!--
//TODO: Description

@demo demo/index.html
-->
<dom-module id="gn-api">
  <template>

    <iron-ajax
      auto
      id="route"
      handle-as="json"
      last-response="{{ route }}"></iron-ajax>
      
    <iron-ajax
      auto
      id="range"
      handle-as="json"
      last-response="{{ range }}"></iron-ajax>

    <iron-ajax
      id="getOriginOsmId"
      url="https://api.pickpoint.io/v1/forward?key=7szZGLLUxmE-Kk3ERCK3"
      handle-as="json"
      on-response="handleOriginResponse"></iron-ajax>

    <iron-ajax
      id="getDestinationOsmId"
      url="https://api.pickpoint.io/v1/forward?key=7szZGLLUxmE-Kk3ERCK3"
      handle-as="json"
      on-response="handleDestinationResponse"></iron-ajax>
      
  </template>

  <script>
  
  Polymer({
    is: 'gn-api',
    
    properties: {

      // Server URL
      url: {
        type: String,
        value: "http://localhost:6833/greennav/"
      },
      
      /**
       * List of available vehicles obtained from the backend
       */
      vehicles: { 
        type: Array,
        notify: true 
      },
      
      /**
       * Set the vehicle to route with. Needed for route and range
       * calculation.
       * 
       * Possible values are listed in the vehicles variable
       */
      vehicleIndex: {
        type: Number,
        notify: true
      },
      
      /**
       * Route/range start as OSM-ID -- currently not used
       */
      originOsmId: Number,
      
      /**
       * Route target as OSM-ID -- currently not used
       */
      destinationOsmId: Number,
      
      /**
       * Battery load percentage.
       * Can be any value from 100 to 0
       */
      battery: {
        type: Number,
        notify: true,
      },
      
      /**
       * Result of the routing. Needs vehicle, startOsmId,
       * targetOsmId and battery to be defined. It's not 
       * calculated automatically, call getRoute() first!
       */
      route: {
        type: Object,
        notify: true
      },
      
      /**
       * Result of the range. Needs vehicle, startOsmId
       * and battery to be defined. It's not 
       * calculated automatically, call getRange() first!
       */
      range: {
        type: Object,
        notify: true
      }
    },
    
    /**
     * Get the vehicles list
     * TODO: vehicles are static for now
     *       later we need some back end communication
     */
    getVehicles : function() {
      vehicles = ["Fiat Fiorino",
        "Smart Roadster", 
        "Sam", 
        "Citysax", 
        "MUTE", 
        "Spyder-S", 
        "Think", 
        "Luis", 
        "STROMOS", 
        "Karabag Fiat 500E", 
        "Lupower Fiat 500E"
      ];
      return vehicles;
    },

    /**
     * Sets the route variable
     */
    getRoute : function() {
      var ajax = this.$.route;
      ajax.url = this.url +
        "vehicles/"   + this.vehicleIndex +
        "/routes/"    + this.originOsmId +
        "-"           + this.destinationOsmId +
        "/opt/energy" +
        "?battery="   + this.battery +
        "&algorithm=EnergyAStar";
      console.log(ajax.url);
    },
    
    /**
     * Sets the range variable
     */
    getRange : function() {
      var ajax = document.querySelector('#range');
      ajax.url = this.url +
        "vehicles/"   + this.vehicle +
        "/ranges/"    + this.startOsmId +
        "?battery="   + this.battery;
    },

    convertInputToOsmId: function() {
      this.pickPointUrl = "https://api.pickpoint.io/v1/forward?key=7szZGLLUxmE-Kk3ERCK3&q=";
      this.$.getOriginOsmId.url = this.pickPointUrl + this.origin;
      this.$.getOriginOsmId.generateRequest();

      this.$.getDestinationOsmId.url = this.pickPointUrl + this.destination;
      this.$.getDestinationOsmId.generateRequest();
    },

    handleOriginResponse: function(event) {
      this.originOsmId = event.detail.response[0].osm_id;
      console.log(event.detail.response[0].osm_id);
    },

    handleDestinationResponse: function(event) {
      this.destinationOsmId = event.detail.response[0].osm_id;
      console.log(event.detail.response[0].osm_id);

      // Wait until (hopefully) both OSM IDs come back...
      // I know, this is terrible. Will research & implement better options (some sort of a callback).
      window.setTimeout(this.getRoute(), 1000);
    }
  });
  </script>
</dom-module>