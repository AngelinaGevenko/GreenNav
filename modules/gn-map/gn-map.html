<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel="stylesheet" href="ol3gm.css" type="text/css">
<link rel="stylesheet" href="https://openlayers.org/en/v3.19.1/css/ol.css" type="text/css">

<script src="https://openlayers.org/en/v3.19.1/build/ol.js" type="text/javascript"></script>
<script src="https://maps.googleapis.com/maps/api/js?v=3&key=AIzaSyCURfGidiiyj4S8XFOPFftNlhfx5A6ce8o" type="text/javascript"></script>
<script type="text/javascript" src="ol3gm.js"></script>

<dom-module id="gn-map">
  <template>
    <style is="custom-style" include="iron-flex iron-flex-alignment"></style>
    <style>
      #map {
        height: 100%;
        width: 100%;
        position: relative;
      }

      #overlayMenu {
        top: 20px;
        right: 20px;
        padding: 10px;
        background: rgba(255,255,255,0.8);
        position: absolute;
        z-index: 10;
        border-radius: 10px;
      }

      #overlayMenu > * {
        margin: 5px 0px
      }

      #overlayToggleButton {
        margin: 0;
        --paper-icon-button: {
          width: 40px;
          height: 40px;
        }        
      }

      paper-icon-button {
        background-color: var(--app-primary-color);
        color: white;
        border-radius: 20px
      }

      paper-toggle-button {
        --paper-toggle-button-checked-bar-color:  var(--app-primary-color);
        --paper-toggle-button-checked-button-color:  var(--app-primary-color);
        --paper-toggle-button-checked-ink-color: var(--app-primary-color);
      }      
    </style>
    <div id="map" class="map">
      <div id="overlayMenu">
        <div class="vertical layout end">
          <div class="flex-end-justified">
            <paper-icon-button id="overlayToggleButton" on-tap="toggleOverlay" icon="expand-less"></paper-icon-button>
          </div>
        </div>
        <div hidden="{{overlayMenuHidden}}">
          <paper-dropdown-menu label="Map Type">
            <paper-listbox class="dropdown-content" selected={{mapType}} attr-for-selected="value">
              <paper-item value="OpenStreetMap">Open Street Map</paper-item>
              <paper-item value="GoogleMap">Google Map</paper-item>
            </paper-listbox>
          </paper-dropdown-menu>
          <paper-toggle-button disabled="{{!_isGoogleMap(mapType)}}" checked="{{traffic}}">Traffic</paper-toggle-button>
        </div>        
      </div>
    </div>
  </template>
<script>
  Polymer({
    is: 'gn-map',

    properties: {
      /**
       * A latitude to center the map on.
       */
      latitude: {
        type: Number,
        notify: true,
        value: 48.139,
        reflectToAttribute: true
      },

      /**
       * A longitude to center the map on.
       */
      longitude: {
        type: Number,
        notify: true,
        value: 11.566,
        reflectToAttribute: true
      },

      /**
       * A zoom level which will be applied to the map.
       */
      zoom: {
        type: Number,
        value: 11,
        notify: true,
        reflectToAttribute: true
      },

      /**
       * The map-type attribute is used to support different maps
       * Possible values are "GoogleMap" or "OpenStreetMap".
       */
      mapType: {
        type: String,
        value: 'GoogleMap',
        notify: true,
        observer: '_toggleMapType'
      },

      /**
       * Array of polygon objects.
       */
      polygons: {
        type: Array,
        readOnly: true,
      },

      /**
       * Array of Marker objects.
       */
      markers: {
        type: Array,
        readOnly: true,
      },

      /**
       * Shows weather in major cities within the map bounds if `true`.
       */
      weather: {
        type: Boolean,
        reflectToAttribute: true,
        notify: true,
        value: false,
        observer: 'toggleWeather'
      },

      /**
       * Shows a precipitation layer if `true`.
       */
      precipitation: {
        type: Boolean,
        reflectToAttribute: true,
        value: false,
        observer: 'togglePrecipitation'
      },

      /**
       * Shows a traffic layer if `true`.
       */
      traffic: {
        type: Boolean,
        reflectToAttribute: true,
        value: false,
        observer: 'toggleTraffic'
      },

      overlayMenuHidden: {
        type: Boolean,
        value: false
      },

      _map: {
        type: Object
      },

      _layers: {
        type: Array,
        value: []
      }
    },

    attached: function() {
      // Create a Google Maps layer
      var googleLayer = new olgm.layer.Google({
        visible: true,
        type: 'base',
        title: 'GoogleMaps'
      });
      // Create OSM Layer
      var osmLayer = new ol.layer.Tile({
        visible: false,
        type: 'base',
        title: 'OpenStreetMap',
        source: new ol.source.OSM()
      })

      this._layers.push(googleLayer);
      this._layers.push(osmLayer);

      this._map = new ol.Map({
        interactions: olgm.interaction.defaults(),
        layers: this._layers,
        target: 'map',
        view: new ol.View({
          center: ol.proj.fromLonLat([this.longitude, this.latitude]),
          zoom: this.zoom
        })
      });

      this._olGM = new olgm.OLGoogleMaps({map: this._map}); // map is the ol.Map instance
      this._olGM.activate();
      this._trafficLayer = new google.maps.TrafficLayer();
    },

    /**
     * Toggles the weather icons on the map.
     *
     * @method toggleWeather
     */
    toggleWeather: function() {

    },

    /**
     * Toggles the precipitation layer on the map.
     *
     * @method togglePrecipitation
     */
    togglePrecipitation: function() {

    },

    /**
     * Toggles the traffic layer on the map.
     *
     * @method toggleTraffic
     */
    toggleTraffic: function() {
      if(typeof this._trafficLayer != 'undefined') {
        if(this.traffic) {
          var gmap = this._olGM.getGoogleMapsMap();
          this._trafficLayer.setMap(gmap);
        }
        else {
          this._trafficLayer.setMap();
        }
      }
    },

    _toggleMapType: function() {
      if(typeof this._layers != 'undefined') {
        if(this.mapType == 'GoogleMap') {
          this._layers[0].setVisible(true);
          this._layers[1].setVisible(false);
        }
        else {
          this._layers[0].setVisible(false);
          this._layers[1].setVisible(true);       
        }
      }
    },

    _isGoogleMap: function(mapType) {
      return mapType == 'GoogleMap'
    },

    toggleOverlay: function() {
      if(this.overlayMenuHidden) {
        this.overlayMenuHidden = false;
        this.$.overlayToggleButton.icon = "expand-less";
        this.$.overlayMenu.style.background = "rgba(255,255,255,0.8)"
      }
      else {
        this.overlayMenuHidden = true;
        this.$.overlayToggleButton.icon = "expand-more"; 
        this.$.overlayMenu.style.background = "rgba(255,255,255,0.0)"   
      }
    },

    /**
     * Adds a polygon to the map.
     *
     * @method addPolygon
     */
    setRoute: (points, strokeColor, width, closed, fillColor, fillOpacity) => {
     
    },

    /**
     * Adds a marker to the map.
     *
     * @method addMarker
     */
    addMarker: (latitude, longitude) => {

    }
  });
</script>

</dom-module>