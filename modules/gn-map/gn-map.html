<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel="stylesheet" href="https://openlayers.org/en/v3.19.1/css/ol.css" type="text/css">
<script src="https://openlayers.org/en/v3.19.1/build/ol.js" type="text/javascript"></script>

<dom-module id="gn-map">
  <template>
    <style is="custom-style" include="iron-flex iron-flex-alignment"></style>
    <style>
      #map {
        height: 100%;
        width: 100%;
        position: relative;
      }

      #overlayMenu {
        top: 20px;
        right: 20px;
        padding: 10px;
        background: rgba(255,255,255,0.8);
        position: absolute;
        z-index: 10;
        border-radius: 10px;
      }

      #overlayMenu > * {
        margin: 5px 0px
      }

      #overlayToggleButton {
        margin: 0;
        --paper-icon-button: {
          width: 40px;
          height: 40px;
        }        
      }

      paper-icon-button {
        background-color: var(--app-primary-color);
        color: white;
        border-radius: 20px
      }

      paper-toggle-button {
        --paper-toggle-button-checked-bar-color:  var(--app-primary-color);
        --paper-toggle-button-checked-button-color:  var(--app-primary-color);
        --paper-toggle-button-checked-ink-color: var(--app-primary-color);
      }      
    </style>
    <div id="map" class="map">
      <div id="overlayMenu">
        <div class="vertical layout end">
          <div class="flex-end-justified">
            <paper-icon-button id="overlayToggleButton" on-tap="toggleOverlay" icon="expand-less"></paper-icon-button>
          </div>
        </div>
        <div hidden="{{overlayMenuHidden}}">
          <paper-dropdown-menu label="Map Type">
            <paper-listbox class="dropdown-content" selected={{mapType}} attr-for-selected="value">
              <paper-item value="OpenStreetMap">Open Street Map</paper-item>
              <paper-item value="GoogleMap">Google Map</paper-item>
            </paper-listbox>
          </paper-dropdown-menu>
          <paper-toggle-button checked="{{traffic}}">Traffic</paper-toggle-button>
        </div>        
      </div>
    </div>
  </template>
<script>
  Polymer({
    is: 'gn-map',

    properties: {
      /**
       * A latitude to center the map on.
       */
      latitude: {
        type: Number,
        notify: true,
        value: 48.139,
        reflectToAttribute: true
      },

      /**
       * A longitude to center the map on.
       */
      longitude: {
        type: Number,
        notify: true,
        value: 11.566,
        reflectToAttribute: true
      },

      /**
       * A zoom level which will be applied to the map.
       */
      zoom: {
        type: Number,
        value: 11,
        notify: true,
        reflectToAttribute: true
      },

      /**
       * The map-type attribute is used to support different maps
       * Possible values are "GoogleMap" or "OpenStreetMap".
       */
      mapType: {
        type: String,
        value: 'GoogleMap',
        notify: true,
        observer: '_toggleMapType'
      },

      /**
       * Array of Marker objects.
       */
      markers: {
        type: Array,
        readOnly: true,
      },

      /**
       * Array of lon lat points
       */
      route: {
        type: Array,
        value: function() {return []},
        observer: 'setRoute'
      },

      /**
       * Shows weather in major cities within the map bounds if `true`.
       */
      weather: {
        type: Boolean,
        reflectToAttribute: true,
        notify: true,
        value: false,
        observer: 'toggleWeather'
      },

      /**
       * Shows a precipitation layer if `true`.
       */
      precipitation: {
        type: Boolean,
        reflectToAttribute: true,
        value: false,
        observer: 'togglePrecipitation'
      },

      /**
       * Shows a traffic layer if `true`.
       */
      traffic: {
        type: Boolean,
        reflectToAttribute: true,
        value: false,
        observer: 'toggleTraffic'
      },

      overlayMenuHidden: {
        type: Boolean,
        value: false
      },

      _map: {
        type: Object
      },

      _layers: {
        type: Array,
        value: []
      }
    },

    attached: function() {
      // Create a Google Maps layer
      var googleLayer = new ol.layer.Tile({
        source: new ol.source.OSM({
          url: 'http://mt{0-3}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}',
          attributions: [
            new ol.Attribution({ html: 'Â© Google' }),
            new ol.Attribution({ html: '<a href="https://developers.google.com/maps/terms">Terms of Use.</a>' })
          ]
        })
      });

      // Create OSM Layer
      var osmLayer = new ol.layer.Tile({
        visible: false,
        type: 'base',
        title: 'OpenStreetMap',
        source: new ol.source.OSM()
      })
      
      var routeLayer = new ol.layer.Vector();

      var computeQuadKey = function(x, y, z) {
        var quadKeyDigits = [];
        for (var i = z; i > 0; i--) {
            var digit = 0;
            var mask = 1 << (i - 1);

            if ((x & mask) != 0)
                digit++;
            if ((y & mask) != 0)
                digit = digit + 2;

            quadKeyDigits.push(digit);
        }
        return quadKeyDigits.join('');
      };

      var trafficLayer = new ol.layer.Tile({
          visible: this.traffic,
          source: new ol.source.XYZ({
              maxZoom: 19,
              tileUrlFunction(tileCoord, pixelRatio, projection) {
                  var z = tileCoord[0];
                  var x = tileCoord[1];
                  var y = -tileCoord[2] - 1;
                  return "http://t0.tiles.virtualearth.net/tiles/t" + computeQuadKey(x, y, z) + ".png";
              }
          })
      });

      this._layers.push(googleLayer);
      this._layers.push(osmLayer);
      this._layers.push(trafficLayer);
      this._layers.push(routeLayer);

      this._map = new ol.Map({
        layers: this._layers,
        target: 'map',
        view: new ol.View({
          center: ol.proj.fromLonLat([this.longitude, this.latitude]),
          zoom: this.zoom
        })
      });

    },

    /**
     * Toggles the weather icons on the map.
     *
     * @method toggleWeather
     */
    toggleWeather: function() {

    },

    /**
     * Toggles the precipitation layer on the map.
     *
     * @method togglePrecipitation
     */
    togglePrecipitation: function() {

    },

    /**
     * Toggles the traffic layer on the map.
     *
     * @method toggleTraffic
     */
    toggleTraffic: function() {
      if(typeof this._layers != 'undefined') {
        if(this.traffic) {
          this._layers[2].setVisible(true);
        }
        else {
          this._layers[2].setVisible(false);
        }
      }
    },

    _toggleMapType: function() {
      if(typeof this._layers != 'undefined') {
        if(this.mapType == 'GoogleMap') {
          this._layers[0].setVisible(true);
          this._layers[1].setVisible(false);
        }
        else {
          this._layers[0].setVisible(false);
          this._layers[1].setVisible(true);       
        }
      }
    },

    toggleOverlay: function() {
      if(this.overlayMenuHidden) {
        this.overlayMenuHidden = false;
        this.$.overlayToggleButton.icon = "expand-less";
        this.$.overlayMenu.style.background = "rgba(255,255,255,0.8)"
      }
      else {
        this.overlayMenuHidden = true;
        this.$.overlayToggleButton.icon = "expand-more"; 
        this.$.overlayMenu.style.background = "rgba(255,255,255,0.0)"   
      }
    },

    /**
     * Adds a polygon to the map.
     *
     * @method addPolygon
     */
    setRoute: function () {
      if(typeof this._layers != 'undefined') {
        var coords = [];
        this.route.forEach(point => {
          coords.push([point.longitude, point.latitude]);
        });
        var lineString = new ol.geom.LineString(coords);
        // transform to EPSG:3857
        lineString.transform('EPSG:4326', 'EPSG:3857');

        // create the feature
        var feature = new ol.Feature({
            geometry: lineString,
            name: 'Line'
        });

        var lineStyle = new ol.style.Style({
            stroke: new ol.style.Stroke({
                color: '#ff0000',
                width: 2
            })
        });

        var source = new ol.source.Vector({
          features: [feature]
        });

        this._map.getView().setCenter(ol.proj.transform([coords[0][0], coords[0][1]], 'EPSG:4326', 'EPSG:3857'));
        this._map.getView().setZoom(18);

        this._layers[3].setSource(source);
        this._layers[3].setStyle(lineStyle);
      }
    },

    /**
     * Adds a marker to the map.
     *
     * @method addMarker
     */
    addMarker: (latitude, longitude) => {

    }
  });
</script>

</dom-module>